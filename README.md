![Message Counter Pro Banner](https://db.nlcat.dpdns.org/banner-twitter-1500x500%20(7).png)

# Discord Message counter

é€™æ˜¯ä¸€æ¬¾å°ˆç‚ºå¤§åž‹ Discord ä¼ºæœå™¨è¨­è¨ˆçš„é«˜æ•ˆèƒ½è¨Šæ¯è¨ˆæ•¸æ©Ÿå™¨äººã€‚å®ƒæŽ¡ç”¨äº†å…ˆé€²çš„å¿«å–ç­–ç•¥èˆ‡éžåŒæ­¥è™•ç†æž¶æ§‹ï¼Œèƒ½å¤ åœ¨ä¸å½±éŸ¿æ©Ÿå™¨äººå›žæ‡‰é€Ÿåº¦çš„å‰æä¸‹ï¼Œç²¾ç¢ºã€å³æ™‚åœ°çµ±è¨ˆä¼ºæœå™¨å…§æ‰€æœ‰æˆå“¡çš„è¨Šæ¯æ•¸é‡ï¼Œä¸¦æä¾›äº’å‹•å¼çš„æŽ’è¡Œæ¦œåŠŸèƒ½ã€‚

![TypeScript](https://img.shields.io/badge/TypeScript-3178C6?style=for-the-badge&logo=typescript&logoColor=white)
![Node.js](https://img.shields.io/badge/Node.js-339933?style=for-the-badge&logo=nodedotjs&logoColor=white)
![Discord.js](https://img.shields.io/badge/Discord.js-5865F2?style=for-the-badge&logo=discord&logoColor=white)
![PostgreSQL](https://img.shields.io/badge/PostgreSQL-4169E1?style=for-the-badge&logo=postgresql&logoColor=white)
![Redis](https://img.shields.io/badge/Redis-DC382D?style=for-the-badge&logo=redis&logoColor=white)

## âœ¨ æ ¸å¿ƒåŠŸèƒ½

- **é«˜æ•ˆèƒ½è¨Šæ¯è¨ˆæ•¸**: æŽ¡ç”¨ **Write-Behind Caching (å¾Œå¯«å¿«å–)** æ¨¡å¼ï¼Œæ–°è¨Šæ¯çš„è¨ˆæ•¸æœƒå…ˆå¯«å…¥é«˜é€Ÿçš„ Redis å¿«å–ï¼Œå†ç”±èƒŒæ™¯ä»»å‹™å®šæœŸã€æ‰¹é‡åœ°å¯«å…¥ PostgreSQL è³‡æ–™åº«ï¼Œå¤§å¹…é™ä½Žäº†è³‡æ–™åº«çš„å¯«å…¥å£“åŠ›ï¼Œç¢ºä¿æ©Ÿå™¨äººå³æ™‚å›žæ‡‰ã€‚
- **å³æ™‚æŽ’è¡Œæ¦œ**: åˆ©ç”¨ Redis çš„ Sorted Set è³‡æ–™çµæ§‹ï¼ŒæŽ’è¡Œæ¦œæ•¸æ“šèƒ½å¤ å³æ™‚æ›´æ–°èˆ‡æŸ¥è©¢ï¼Œæä¾›ä½¿ç”¨è€…ç§’ç´šæ›´æ–°çš„æŽ’åé«”é©—ã€‚
- **æ™ºæ…§å¿«å–ç­–ç•¥**:
  - **å•Ÿå‹•é ç†± (Cache Warming)**: æ©Ÿå™¨äººå•Ÿå‹•æ™‚ï¼Œæœƒè‡ªå‹•å¾žè³‡æ–™åº«è®€å–æ¬Šå¨æ•¸æ“šï¼Œé å…ˆè¼‰å…¥åˆ° Redis ä¸­ï¼Œç¢ºä¿å•Ÿå‹•å¾Œç«‹å³æä¾›æº–ç¢ºçš„æŽ’è¡Œæ¦œã€‚
  - **åˆ†é å¿«å– (Pagination Caching)**: å°æŽ’è¡Œæ¦œçš„æ¯ä¸€é æŸ¥è©¢çµæžœé€²è¡Œå¿«å–ï¼Œæ¸›å°‘é‡è¤‡è¨ˆç®—ï¼Œæå‡ç¿»é é€Ÿåº¦ã€‚
  - **å¿«å–å¤±æ•ˆ (Cache Invalidation)**: ç•¶æœ‰æ–°è¨Šæ¯æ™‚ï¼Œæœƒè‡ªå‹•æ¸…é™¤ç›¸é—œçš„æŽ’è¡Œæ¦œåˆ†é å¿«å–ï¼Œç¢ºä¿ä½¿ç”¨è€…ä¸‹æ¬¡æŸ¥è©¢æ™‚èƒ½çœ‹åˆ°æœ€æ–°æ•¸æ“šã€‚
- **å®Œæ•´æ­·å²è¨Šæ¯åŒæ­¥ (`/sync-full`)**:
  - ä½¿ç”¨ **Worker Threads (å·¥ä½œç·šç¨‹)** å¹³è¡Œè™•ç†å¤šå€‹é »é“ï¼Œæ¥µå¤§åœ°æå‡äº†åˆæ¬¡åŒæ­¥æ•´å€‹ä¼ºæœå™¨æ­·å²è¨Šæ¯çš„é€Ÿåº¦ï¼Œé¿å…ä¸»ç·šç¨‹è¢«é•·æ™‚é–“é˜»å¡žã€‚
  - æä¾›è©³ç´°çš„é€²åº¦å›žå ±ï¼ˆé€²åº¦æ¢ã€é è¨ˆå‰©é¤˜æ™‚é–“ã€è™•ç†é€Ÿåº¦ï¼‰ï¼Œä¸¦é€éŽç§è¨Šç™¼é€çµ¦æŒ‡ä»¤ä½¿ç”¨è€…ï¼Œé¿å…æ´—ç‰ˆã€‚
- **å¢žé‡è¨Šæ¯åŒæ­¥ (`/sync-missing`)**: æ©Ÿå™¨äººä¸‹ç·šå¾Œï¼Œå¯é€éŽæ­¤æŒ‡ä»¤å¿«é€ŸæŽƒæä¸¦è£œå…¨éºæ¼çš„è¨Šæ¯ï¼Œç„¡éœ€é€²è¡Œè€—æ™‚çš„å®Œæ•´åŒæ­¥ã€‚
- **é€²éšŽæŽ’è¡Œæ¦œæŸ¥è©¢**: æ”¯æ´æŒ‰ç‰¹å®šé »é“ã€ç‰¹å®šæ—¥æœŸ (`YYYY-MM-DD`) ç¯©é¸æŽ’è¡Œæ¦œã€‚
- **äº’å‹•å¼ä»‹é¢**: æŽ’è¡Œæ¦œæ”¯æ´æŒ‰éˆ•ç¿»é ï¼Œä¸¦æä¾›ã€Œè·³è‡³é æ•¸ã€çš„å½ˆå‡ºå¼è¦–çª—ï¼Œæå‡ä½¿ç”¨è€…é«”é©—ã€‚
- **é«˜å¯é æ€§**:
  - ä½¿ç”¨ **Redis Lock** é˜²æ­¢å¤šå€‹åŒæ­¥ä»»å‹™åŒæ™‚åŸ·è¡Œï¼Œç¢ºä¿è³‡æ–™ä¸€è‡´æ€§ã€‚
  - è³‡æ–™åº«æ“ä½œæŽ¡ç”¨äº¤æ˜“ (Transaction)ï¼Œç¢ºä¿æ‰¹æ¬¡å¯«å…¥çš„åŽŸå­æ€§ã€‚

## ðŸ›ï¸ æŠ€è¡“æž¶æ§‹

æœ¬å°ˆæ¡ˆçš„æ•¸æ“šæµèˆ‡æ ¸å¿ƒæž¶æ§‹å¦‚ä¸‹ï¼š

```
                                  +-----------------------+
                                  |   Discord Message     |
                                  +-----------+-----------+
                                              |
                                              v
+-----------------------------------------------------------------------------------------+
|                                  Discord Bot (Node.js)                                  |
|                                                                                         |
|  +-------------------------+      +---------------------------+     +-------------------+
|  |   messageCreate Event   |----->|      Redis (Cache)        |<--->|   /leaderboard    |
|  +-------------------------+      |                           |     |      Command      |
|              |                    | 1. Dirty Hashes (å¢žé‡)    |     +-------------------+
|              |                    | 2. Sorted Set (å³æ™‚æŽ’å)  |               |
|              +------------------->| 3. Page Cache (åˆ†é çµæžœ)  |---------------+
|                                   +---------------------------+               |
|                                              |                                |
|          (Every 30s)                         | (Batch Write)                  | (Cache Miss/Filtered)
|                v                             v                                v
|  +-----------------------------+    +-------------------------------------------------+
|  |   Write-Behind Job          |--->|             PostgreSQL (Database)               |
|  | (flushDirtyCountsToDB)      |    |            (The Source of Truth)                |
|  +-----------------------------+    +-------------------------------------------------+
|                                                                                         |
+-----------------------------------------------------------------------------------------+

 Worker Threads for /sync-full:
 [ Main Thread ] <--- (Aggregated Data) --- [ Worker 1: Channels A, B ]
                                          /
               <--- (Aggregated Data) --- [ Worker 2: Channels C, D ]
                                          /
               <--- (AggregatedData)  --- [ Worker n: ...         ]

```

1.  **è¨Šæ¯è¨ˆæ•¸**:
    - ç•¶ä½¿ç”¨è€…ç™¼é€ä¸€å‰‡è¨Šæ¯ï¼Œ`messageCreate` äº‹ä»¶è¢«è§¸ç™¼ã€‚
    - æ©Ÿå™¨äººæœƒå° Redis åŸ·è¡Œå…©å€‹æ“ä½œï¼š
      1.  åœ¨ä¸€å€‹ Hash ä¸­ (`dirty_counts:{guild_id}`) ç´¯åŠ è©²ä½¿ç”¨è€…åœ¨è©²é »é“çš„ç•¶æ—¥è¨Šæ¯æ•¸ï¼ˆæ­¤ç‚º "é«’" æ•¸æ“šï¼‰ã€‚
      2.  åœ¨ä¸€å€‹ Sorted Set ä¸­ (`leaderboard:{guild_id}`) å°‡è©²ä½¿ç”¨è€…çš„ç¸½åˆ†ï¼ˆç¸½è¨Šæ¯æ•¸ï¼‰åŠ ä¸€ï¼Œç”¨æ–¼å³æ™‚æŽ’è¡Œæ¦œã€‚
2.  **æ‰¹æ¬¡å¯«å…¥è³‡æ–™åº«**:
    - ä¸€å€‹å®šæ™‚ä»»å‹™ (`setInterval`) æ¯ 30 ç§’æœƒè§¸ç™¼ `flushDirtyCountsToDB` å‡½å¼ã€‚
    - æ­¤å‡½å¼æœƒå¾ž Redis å–å‡ºæ‰€æœ‰ "é«’" æ•¸æ“šï¼Œä¸¦ä½¿ç”¨ PostgreSQL é«˜æ•ˆçŽ‡çš„ `UNNEST` å’Œ `ON CONFLICT ... DO UPDATE` èªžæ³•ï¼Œä¸€æ¬¡æ€§åœ°å°‡å¤§é‡æ›´æ–°å¯«å…¥è³‡æ–™åº«ã€‚
3.  **æŽ’è¡Œæ¦œæŸ¥è©¢**:
    - ä½¿ç”¨è€…åŸ·è¡Œ `/leaderboard` æŒ‡ä»¤ã€‚
    - **é è¨­æƒ…æ³ (ç„¡ç¯©é¸)**: ç›´æŽ¥å¾ž Redis çš„ Sorted Set ä¸­å–å¾—æŽ’åï¼Œé€Ÿåº¦æ¥µå¿«ã€‚
    - **ç¯©é¸æƒ…æ³ (æŒ‡å®šé »é“/æ—¥æœŸ)**: ç›´æŽ¥æŸ¥è©¢ PostgreSQL è³‡æ–™åº«ä»¥ç²å–æœ€ç²¾ç¢ºçš„çµæžœã€‚
    - æŸ¥è©¢çµæžœæœƒè¢«å¿«å–åœ¨ Redis ä¸­ï¼Œä»¥åŠ é€Ÿå¾ŒçºŒçš„ç›¸åŒæŸ¥è©¢ã€‚

## âš™ï¸ å®‰è£èˆ‡è¨­å®š

### 1. ç’°å¢ƒéœ€æ±‚

- [Node.js](https://nodejs.org/) v24.x æˆ–æ›´é«˜ç‰ˆæœ¬
- [PostgreSQL](https://www.postgresql.org/) v17.x æˆ–æ›´é«˜ç‰ˆæœ¬
- [Redis](https://redis.io/) v6.x æˆ–æ›´é«˜ç‰ˆæœ¬

### 2. å°ˆæ¡ˆè¨­å®š

1.  **è¤‡è£½å°ˆæ¡ˆ**
    ```bash
    git clone https://github.com/956zs/discord-message-counter.git
    cd discord-message-counter
    ```

2.  **å®‰è£ä¾è³´**
    ```bash
    npm install
    ```

3.  **è¨­å®šç’°å¢ƒè®Šæ•¸**
    è¤‡è£½ `.env.example` æ–‡ä»¶ç‚º `.env`ï¼Œä¸¦å¡«å…¥æ‚¨çš„è¨­å®šï¼š
    ```env
    # Discord Bot
    DISCORD_TOKEN=ä½ çš„æ©Ÿå™¨äººToken
    CLIENT_ID=ä½ çš„æ©Ÿå™¨äººClient_ID

    # PostgreSQL Database
    DB_HOST=localhost
    DB_PORT=5432
    DB_USER=postgres
    DB_PASSWORD=ä½ çš„è³‡æ–™åº«å¯†ç¢¼
    DB_DATABASE=discord_counter

    # Redis
    REDIS_HOST=localhost
    REDIS_PORT=6379
    REDIS_PASSWORD= # å¦‚æžœä½ çš„Redisæœ‰å¯†ç¢¼ï¼Œè«‹å¡«å¯«
    REDIS_DB=2 # å»ºè­°ç‚ºæ©Ÿå™¨äººä½¿ç”¨ä¸€å€‹ç¨ç«‹çš„DB
    ```

4.  **è¨­å®šè³‡æ–™åº«**
    é€£æŽ¥åˆ°æ‚¨çš„ PostgreSQL è³‡æ–™åº«ï¼Œä¸¦åŸ·è¡Œä»¥ä¸‹ SQL æŒ‡ä»¤ä¾†å»ºç«‹å¿…è¦çš„è³‡æ–™è¡¨ï¼š

    ```sql
    -- å„²å­˜æ¯æ—¥è¨Šæ¯è¨ˆæ•¸çš„è³‡æ–™è¡¨
    CREATE TABLE message_counts (
        user_id BIGINT NOT NULL,
        guild_id BIGINT NOT NULL,
        channel_id BIGINT NOT NULL,
        message_date DATE NOT NULL,
        count INTEGER NOT NULL DEFAULT 0,
        PRIMARY KEY (user_id, guild_id, channel_id, message_date)
    );

    -- å‰µå»ºç´¢å¼•ä»¥å„ªåŒ–æŸ¥è©¢
    CREATE INDEX idx_message_counts_guild_user ON message_counts(guild_id, user_id);
    CREATE INDEX idx_message_counts_guild_date ON message_counts(guild_id, message_date);

    -- å„²å­˜åŒæ­¥ç‹€æ…‹çš„è³‡æ–™è¡¨
    CREATE TABLE sync_status (
        guild_id BIGINT PRIMARY KEY,
        full_sync_status VARCHAR(20) DEFAULT 'none', -- none, in_progress, completed, failed
        last_full_sync_updated TIMESTAMPTZ,
        last_known_message_id BIGINT
    );
    ```

5.  **ç·¨è­¯ TypeScript**
    ```bash
    npm run build
    ```
    é€™æœƒå°‡ `src` ç›®éŒ„ä¸‹çš„ TypeScript æª”æ¡ˆç·¨è­¯æˆ JavaScriptï¼Œä¸¦è¼¸å‡ºåˆ° `dist` ç›®éŒ„ã€‚

## ðŸš€ åŸ·è¡Œå°ˆæ¡ˆ

1.  **éƒ¨ç½²æ–œç·šæŒ‡ä»¤ (åªéœ€åŸ·è¡Œä¸€æ¬¡)**
    åœ¨ç¬¬ä¸€æ¬¡å•Ÿå‹•æˆ–ä¿®æ”¹äº†æŒ‡ä»¤å®šç¾©å¾Œï¼Œéœ€è¦åŸ·è¡Œæ­¤æŒ‡ä»¤å°‡æŒ‡ä»¤è¨»å†Šåˆ° Discordã€‚
    ```bash
    npm run deploy
    ```

2.  **å•Ÿå‹•æ©Ÿå™¨äºº (ç”Ÿç”¢ç’°å¢ƒ)**
    ```bash
    npm run start
    ```

3.  **å•Ÿå‹•æ©Ÿå™¨äºº (é–‹ç™¼ç’°å¢ƒ)**
    ä½¿ç”¨ `nodemon` å’Œ `ts-node`ï¼Œåœ¨ç¨‹å¼ç¢¼è®Šæ›´æ™‚æœƒè‡ªå‹•é‡å•Ÿï¼Œæ–¹ä¾¿é–‹ç™¼ã€‚
    ```bash
    npm run dev
    ```

## ðŸ“‹ å¯ç”¨æŒ‡ä»¤

- `/leaderboard [channel] [date]`
  - é¡¯ç¤ºä¼ºæœå™¨è¨Šæ¯æŽ’è¡Œæ¦œã€‚
  - `channel` (å¯é¸): åªé¡¯ç¤ºç‰¹å®šé »é“çš„æŽ’è¡Œæ¦œã€‚
  - `date` (å¯é¸): åªé¡¯ç¤ºç‰¹å®šæ—¥æœŸçš„æŽ’è¡Œæ¦œ (æ ¼å¼: `YYYY-MM-DD`)ã€‚

- `/sync-full` (åƒ…é™ç®¡ç†å“¡)
  - **ã€é«˜è€—æ™‚/å±éšªã€‘** åˆªé™¤ä¼ºæœå™¨æ‰€æœ‰ç¾æœ‰è¨ˆæ•¸ï¼Œä¸¦å¾žé ­é–‹å§‹åŒæ­¥æ‰€æœ‰é »é“çš„æ­·å²è¨Šæ¯ã€‚é©ç”¨æ–¼é¦–æ¬¡è¨­å®šæˆ–æ•¸æ“šåš´é‡ææ¯€æ™‚ã€‚

- `/sync-missing` (åƒ…é™ç®¡ç†å“¡)
  - **ã€å¿«é€Ÿã€‘** æŽƒæä¸¦è£œå…¨æ©Ÿå™¨äººä¸‹ç·šæœŸé–“éºæ¼çš„è¨Šæ¯ã€‚å»ºè­°åœ¨æ©Ÿå™¨äººé‡å•Ÿå¾ŒåŸ·è¡Œã€‚

